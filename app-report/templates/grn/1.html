<!doctype html>
<html lang="en">
<head>
    <title>The Whistle / Global Rights Nigeria Incident Report | Identifier name</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="//unpkg.com/purecss@1.0.0/build/pure-min.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/grn.css">
    <style>
        input { margin-right: 0.2em; width: 16em; }
        output { font-weight: bold; }
        button#get-alt-name { margin-left: 1em; }
        .name-available { float: right; font-weight: bold; margin-top: 1em; }
        #name-ok { color: #009900; }
        #name-nok { color: #990000; }
    </style>
    <script defer src="/js/report.js"></script>
    <script>
        'use strict';

        // use ajax to fill in name so that no special treatment is required within handlers

        document.addEventListener('DOMContentLoaded', async function() {

            // if we have no name on opening page, fetch a random one
            if (document.querySelector('#generated-name').value == '') generateName();

            if (document.querySelector('#existing-name').value.trim() != '') {
                await verifyExistingName(document.querySelector('#existing-name').value);
            }

            // listener for 'get alternative' name button
            document.querySelector('#get-alt-name').onclick = generateName;

            // check entered existing name letter-by-letter
            document.querySelector('#existing-name').oninput = async function() {
                await verifyExistingName(this.value);
            };

        });

        async function generateName() {
            const headers = { Accept: 'application/json' };
            const credentials = 'same-origin';
            const response = await fetch('/ajax/test/names/new', { method: 'GET', headers, credentials });
            const body = await response.json();
            if (response.ok) {
                document.querySelector('#generated-name').value = body.name;
                document.querySelector('input[name=generated-name]').value = body.name;
                //await verifyExistingName(body.name);
            } else {
                alert(body.message);
            }
        }

        async function verifyExistingName(name) {
            if (name.trim() == '') {
                document.querySelector('#existing-name').setCustomValidity('');
                document.querySelector('#name-ok').classList.add('hide');
                document.querySelector('#name-nok').classList.add('hide');
                document.querySelector('#generated-name').classList.remove('hide');
                return;
            }
            const headers = { Accept: 'application/json' };
            const credentials = 'same-origin';
            const response = await fetch('/ajax/test/names/'+name, { method: 'GET', headers, credentials });
            const body = await response.json();
            switch (response.status) {
                case 200: // name exists
                    document.querySelector('#existing-name').setCustomValidity('');
                    document.querySelector('#name-ok').classList.remove('hide');
                    document.querySelector('#name-nok').classList.add('hide');
                    document.querySelector('#generated-name').classList.add('hide');
                    break;
                case 404: // name not found
                    const err = 'Name not found';
                    document.querySelector('#existing-name').setCustomValidity(err);
                    document.querySelector('#name-ok').classList.add('hide');
                    document.querySelector('#name-nok').classList.remove('hide');
                    document.querySelector('#generated-name').classList.remove('hide');
                    break;
                default: // ?? eg 500?
                    alert(response.body);
                    break;
            }
        }
    </script>
</head>
<body>

<header>
    <nav class="pure-menu pure-menu-horizontal">
        <ul class="pure-menu-list">
            <li class="pure-menu-item"><img src="../img/logo-32.png"></li>
            <li class="pure-menu-item">The Whistle | Global Rights Nigeria Incident Report</li>
        </ul>
    </nav>
</header>

<main>

<table class="progress"><tr><td>p{{p}}/{{n}}</td></tr></table>

<h1>Identifier name</h1>

<p>Your reports are kept anonymous, so to keep a record of you internally, we will use an
    auto-generated name. If you would prefer an alternative name, click on the ‘get alternative name’
    button.</p>

<p>Please make a note of this name, so that we can associate you with this report in any future
    contacts we may have with you.</p>

<p>If you are making another report, please enter your existing auto-generated name in the ‘existing name’
    field.</p>

<ul class="validation-errors">{{#@koa.flash.validation}}<li>{{this}}</li>{{/@koa.flash.validation}}</ul>

<form method="post" class="pure-form pure-form-aligned">
    <ul>
        <li>
            <label>Auto-generated identifier name:</label>
            <button type="button" id="get-alt-name" autofocus class="float-right">get alternative name</button>
            <output id="generated-name">{{generated-name}}</output>
            <input type="hidden" name="generated-name" value="{{generated-name}}">
        </li>
        <li>
            <label for="existing-name">...or existing identifier name</label>
            <span id="name-ok" title="name available" class="name-available hide">✓</span>
            <span id="name-nok" title="name not available" class="name-available hide">✗</span>
            <input type="text" name="existing-name" id="existing-name" value="{{existing-name}}">
        </li>
        <li>
            <label for="existing-name">If you would like to be contacted, give your contact details</label>
            <input type="text" name="contact-details" id="contact-details" value="{{contact-details}}" disabled>
        </li>
        <li class="nav">
            <button type="submit" name="nav-next" value="next" accesskey="n" class="nav next"><u>N</u>ext ⇒</button>
        </li>
    </ul>
</form>

</main>

</body>
</html>
