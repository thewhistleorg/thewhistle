<!doctype html>
<html lang="en">

<head>
    <title>{{reportDescription}}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="/css/dashboard-report.css">
    <link rel="stylesheet" href="/css/card.css">
    <script>
        'use strict';
        document.addEventListener('DOMContentLoaded', function() {
            const credentials = 'same-origin';

            document.querySelector('#add-comment').onclick = postComment;
            document.querySelectorAll('div.by button.edit').forEach(btn => btn.onclick = edit);
            document.querySelectorAll('div.by button.delete').forEach(btn => btn.onclick = confirmDelete);

            async function postComment() {
                const comment = document.querySelector('#comment').value;
                const username = '{{@koa.state.user.name}}';
                const userid = '{{@koa.state.user.id}}';
                const values = JSON.stringify({ comment, username,userid });

                const headers = { 'Content-Type': 'application/json', Accept: 'application/json' };
                const response = await fetch('/ajax/reports/{{_id}}/comments', { method: 'POST', body: values, headers, credentials });
                const body = await response.json();

                if (response.ok) {
                    const div = document.querySelector('#div-add-comment');
                    const html = `<div class="comment" id="${body.id}">
                                 <div class="by"><b><a href="/users/${username}">${username}</a></b> commented <a href="#${body.id}">${body.onPretty}</a>
                                   <button class="float-right fa fa-times delete"></button>
                                   <button class="float-right fa fa-pencil edit">
                                 </div>
                                 <div>${body.comment}</div>
                               </div>`;
                    div.insertAdjacentHTML('beforebegin', html);
                    document.querySelectorAll('div.by button.delete').forEach(btn => btn.onclick = confirmDelete);
                    div.querySelector('#comment').value = '';
                } else {
                    alert(response.status+': ' + body.message);
                }
            }

            async function edit() {
                alert('Comment edit function TBC');
            }

            async function confirmDelete() {
                if (confirm('Are you sure you want to delete this comment?')) {
                    const commentDiv = this.closest('.comment');

                    const headers = { 'Content-Type': 'application/json', Accept: 'application/json' };
                    const response = await fetch(`/ajax/reports/{{_id}}/comments/${commentDiv.id}`, { method: 'DELETE', headers, credentials });

                    if (response.ok) {
                        commentDiv.remove();
                    } else {
                        const body = await response.text();
                        alert(response.status+': '+body);
                    }
                }
            }
        });
    </script>


    <script>
        const reports = {
            '{{_id}}': { lat: {{lat}}, lng: {{lng}}, date: '{{reportedOnDay}}', highlight: {{highlight}}, name: '{{name}}' },
        };
        function initMap() {
            const map = new google.maps.Map(document.getElementById('map'), {
                zoom:   14,
                center: { lat: {{lat}}, lng: {{lng}} }
            });
            map.greatestExtent = new google.maps.LatLngBounds(map.getCenter(), map.getCenter());
            const marker = new google.maps.Marker({
                position: { lat: {{lat}}, lng: {{lng}} },
                icon:  '/map-marker/red/{{highlight}}',
                label: '{{name}}',
                title: '{{reportedOnFull}}', // TODO: use info window for status, etc
                url:   '/reports/{{_id}}',
                map:   map,
            });
            google.maps.event.addListener(map, 'idle', async function() {
                // no need to fetch new reports if we haven't extended bounds beyond previous extent
                const bounds = new google.maps.LatLngBounds(map.greatestExtent.getSouthWest(), map.greatestExtent.getNorthEast());
                const newBounds = map.getBounds();
                const sw = newBounds.getSouthWest();
                const ne = newBounds.getNorthEast();
                bounds.extend(sw).extend(ne);
                if (bounds.equals(map.greatestExtent)) return; // still within previously checked bounds
                map.greatestExtent = bounds;
                try {
                    const headers = { Accept: 'application/json' };
                    const credentials = 'same-origin';
                    const url = `/ajax/reports/within/${sw.lat()},${sw.lng()}:${ne.lat()},${ne.lng()}`;
                    const response = await fetch(url, { method: 'GET', headers, credentials });
                    const body = await response.json();
                    if (response.ok) {
                        for (const report of body.reports) {
                            if (reports[report._id] == undefined) {
                                reports[report._id] = report;
                                const marker = new google.maps.Marker({
                                    position: { lat: report.lat, lng: report.lng },
                                    icon:     '/map-marker/blue/'+report.highlight,
                                    title:    report.reported + ' ' + report.name + ' ' + report.summary, // TODO: use info window for status, etc?
                                    url:      '/reports/'+report._id+'/location',
                                    map:      map,
                                });
                                google.maps.event.addListener(marker, 'click', function() {
                                    window.location.href = marker.url;
                                });
                            }
                        }
                    } else {
                        alert(body.message);
                    }
                } catch (e) {
                    alert(e.message);
                }
            });
        }
    </script>

    <script src="//maps.googleapis.com/maps/api/js?callback=initMap&key=AIzaSyAZTZ78oNn4Y9sFZ1gIWfAsaqVNGav5DGw" defer></script>


    <style>
        #map {
            height: 400px;
            width: 400px;
        }

        p.note {
            color: #999999;
            font-size: 80%;
        }

        h1 {
            border-bottom: none;
        }

        button {
            background: none;
            border: none;
            padding: 4px;
        }

        h1 {
            border-bottom: none;
        }

        div.comment {
            border: 1px solid #ebebeb;
            margin: 0.5em 0;
            max-width: 640px;
        }

        div.comment div {
            padding: 0.5em
        }

        div.comment .by {
            background: #f9f9f9;
        }

        div.comment p {
            margin: 0.5em 0;
        }

        div.by a {
            color: #333333;
        }

        div.by button {
            background: none;
            border: none;
            color: #999999;
        }

        div.by button:hover {
            color: #3992ab;
            cursor: pointer;
        }

        #div-add-comment {
            padding: 0.5em;
            max-width: calc(640px - 1em);
        }

        textarea {
            display: block;
            height: 8em;
            margin-bottom: 0.5em;
            padding: 0.5em;
            width: 96%;
        }

        .padding-15 { padding: 15px; }
    </style>
    <style>
        #files img { max-width: 80px; max-height: 80px; }
    </style>
    <script>
        /* auto-submit on change to summary/assigned/status/archive */
        'use strict';
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelector('#summary').onchange = function submitSummary() {
                this.form.submit();
            };
            document.querySelector('#assigned-to').onchange = function submitAssignedTo() {
                this.form.submit();
            };
            document.querySelector('#status').onchange = function submitStatus() {
                // TODO: trigger interactive validation? pattern="(?!\*)" seems to prevent datalist...
                this.form.submit();
            };
            document.querySelectorAll('[name=archived]').forEach(el => el.onchange = function submitArchived() {
                this.form.submit();
            });
        });
    </script>
    <script>
        /* tags */
        'use strict';
        document.addEventListener('DOMContentLoaded', function () {
            const credentials = 'same-origin';

            document.querySelector('#tag-add').onclick = openTagInputs;
            document.querySelector('#tag-save').onclick = saveTag;
            document.querySelector('#tag-cancel').onclick = cancelEntry;
            document.querySelectorAll('.tag-del').forEach(el => el.onclick = deleteTag);
            window.onkeydown = function (event) {
                if (event.key == 'Escape') cancelEntry()
            };

            function openTagInputs() {
                document.querySelector('#tag-add').classList.add('hide');
                document.querySelector('#new-tag').classList.remove('hide');
                document.querySelector('#tag').focus();
            }

            async function saveTag() {
                const newTagDiv = document.querySelector('#new-tag');
                const tag = newTagDiv.querySelector('#tag').value.toLowerCase();
                if (tag == '') {
                    document.querySelector('#tag-add').classList.remove('hide');
                    document.querySelector('#new-tag').classList.add('hide');
                    return;
                }

                const values = JSON.stringify({
                    tag: tag
                });
                const headers = {
                    'Content-Type': 'application/json',
                    Accept: 'application/json'
                };
                const response = await fetch('/ajax/reports/{{_id}}/tags', {
                    method: 'POST',
                    body: values,
                            headers,
                            credentials
                });
                const body = await response.json();
                if (response.ok) {
                    // create new tag span
                    const tagDelBtn = '<button title="remove tag" class="tag-del hide fa fa-trash red"></button>';
                    const newTag = document.createElement('span'); newTag.classList.add('tag'); newTag.innerHTML = `${tag} ${tagDelBtn}`;
                    newTag.onmouseenter = function () { this.querySelector('button').classList.remove('hide'); }; newTag.onmouseleave
                            = function () { this.querySelector('button').classList.add('hide'); }; newTag.querySelector('button').onclick
                            = deleteTag; // and add it into document before 'add-tag' button const addTagBtn = document.querySelector('#tag-add');
                    addTagBtn.parentNode.insertBefore(newTag, addTagBtn); newTagDiv.querySelector('#tag').value = ''; // reset input
                    document.querySelector('#tag-add').classList.remove('hide'); document.querySelector('#new-tag').classList.add('hide');
                } else { alert(response.status + ': ' + body.message); }
            } async function deleteTag() {
                const tagSpan = this.closest('span');
                const tag = encodeURIComponent(tagSpan.textContent.replace(/ $/, '')); const headers = {
                    'Content-Type': 'application/json',
                    Accept: 'application/json'
                }; const response = await fetch('/ajax/reports/{{_id}}/tags/' + tag, {
                    method: 'DELETE',
                            headers, credentials
                }); const body = await response.json(); if (response.ok) { tagSpan.remove(); } else {
                    alert(body.message);
                }
            } function cancelEntry(event) {
                document.querySelector('#tag').value = '';
                document.querySelector('#new-tag').classList.add('hide');
                document.querySelector('#tag-add').classList.remove('hide');
            }
            document.querySelectorAll('span.tag').forEach(span => span.onmouseenter = function showDeleteButton() { this.querySelector('button').classList.remove('hide'); });
            document.querySelectorAll('span.tag').forEach(span => span.onmouseleave = function hideDeleteButton() {
                this.querySelector('button').classList.add('hide');
            });
        });
    </script>
</head>

<body>

<header>
    {{>navpartial}}
</header>

<main>




    <!--<nav class="tabs">
<ul>
    <li class="active"><a href="/reports/{{_id}}">Metadata</a></li>
    <li><a href="/reports/{{_id}}/submission">Submission</a></li>
    <li><a href="/reports/{{_id}}/files" {{#unless report.files}}class="disabled"{{/unless}}>Documents</a></li>
    <li><a href="/reports/{{_id}}/commentary">Commentary</a></li>
    <li><a href="/reports/{{_id}}/location">Location</a></li>
</ul>
</nav>-->


    <div class="pure-g report-container">

        <div class="pure-u-1 report-header-container">
            <div class="float-left report-header">{{reportDescription}}</div>
            <div class="float-right">
                <small>
                    <a href="{{exportPdf}}" title="Save as PDF" class="link-inverse">
                        <span>Export as PDF </span>
                        <i  class="fa fa-file-pdf-o"></i>
                    </a>
                </small>
            </div>
        </div>

        {{>errpartial}}

        <div class="pure-u-3-5">

            <ul class="card-list">
                <li>
                    <span class="card-header">Submitted Incident Report</span>
                    <div class="padding-15">

                        <p><i>Report id</i>: {{_id}} <i>submitted</i>: {{reportedOnFull}} <span class="small grey">{{reportedOnTz}}</span> <i>by</i> {{reportedBy}}</p>
                        {{{reportHtml}}}

                        <p><i>Note the contents of the incident report will vary according to the organisation/project the
                            report is submitted for.</i></p>
                    </div>
                </li>

                <li id="files">
                    <span class="card-header">Files</span>
                    <div class="image-ctx">
                        {{#if analysis.files}}
                        <table>
                            {{#analysis.files}}
                            <tr id="{{name}}" class="align-top">
                                <td><a href="/{{path}}{{name}}">{{#if isImage}}<img src="/{{path}}{{name}}" alt="{{name}}">{{else}}{{name}}{{/if}}</a></td>
                                <td class="exif">{{distance}} {{direction}} from incident location<div title="{{time}}">{{timeDesc}}</div></td>
                            </tr>
                            {{/analysis.files}}
                        </table>
                        {{else}}
                        <div class="padding-15">No files uploaded by the reporter</div>
                        {{/if}}
                    </div>
                </li>

                <li id="weather">
                    <span class="card-header">Weather </span>
                    <div>
                        {{#if analysis.weather}}
                        <div class="weather-header">
                            {{analysis.weather.city}}, {{analysis.weather.country}}
                            <img src="/img/wundergroundLogo_4c_horz.jpg" alt="Weather Underground" style="width:90px" class="float-right">
                        </div>
                        <div class="weather-body">
                            {{#analysis.weather.observations}}
                            <div class="weather-condition">
                                <div class="weather-condition-hour">{{date.hour}}:{{date.min}}</div>
                                <div title="{{conds}}"><img src="/img/weather/underground/icons/black/png/32x32/{{icon}}.png" alt="{{conds}}"></div>
                            </div>
                            {{/analysis.weather.observations}}
                        </div>
                        {{else}}
                        <div class="padding-15">No date or location provided</div>
                        {{/if}}
                    </div>
                </li>

                <li id="geocoding">
                    <span class="card-header">Geocoding <a href="https://maps.google.com/maps/search/{{formattedAddress}}" class="fa fa-globe"></a></span>
                    <div class="padding-15">
                        <p><i>Report id</i>: {{_id}} <i>submitted</i>: {{reportedOnFull}} <span class="small grey">{{reportedOnTz}}</span> <i>by</i> {{reportedBy}}</p>
                        <div id="map"></div>
                        {{{geocodeHtml}}}
                    </div>
                </li>



            </ul>
        </div>

        <div class="pure-u-2-5">
            <ul class="card-list-sidebar">

                <li>
                    <span class="card-header">Notes</span>
                    <div id="commentsContainer">
                        {{#comments}}
                        <div class="comment" id="{{id}}">
                            <div class="by"><b><a href="/users/{{byName}}">{{byName}}</a></b> commented <a href="#{{id}}" title="{{onFull}}">{{onPretty}}</a>
                                <button class="float-right fa fa-times delete"></button> {{#if owner}}<button class="float-right fa fa-pencil edit"></button>{{/if}}
                            </div>
                            <div>{{{comment}}}</div>
                        </div>
                        {{/comments}}

                        <div class="comment" id="div-add-comment">
                            <textarea name="comment" id="comment" placeholder="Add a comment"></textarea>
                            <button id="add-comment" class="pure-button pure-button-primary">Add comment</button>
                                <span class="small grey">
                                    <svg aria-hidden="true" class="align-middle" height="12" version="1.1" viewBox="0 0 16 16" width="16">
                                        <path fill-rule="evenodd" d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z"></path>
                                    </svg>
                                    Styling with <a href="https://daringfireball.net/projects/markdown/">Markdown</a> is supported; @mentions and #tags can be used
                                </span>
                        </div>
                    </div>
                </li>

                <li>
                    <span class="card-header">Report Actions</span>
                    <div class="report-action">
                        <p><i>Report id</i>: {{_id}} <i>submitted</i>: {{reportedOnFull}} <span class="small grey">{{reportedOnTz}}</span> <i>by</i> {{reportedBy}}</p>

                        <form method="post" class="pure-form pure-form-aligned">
                            <div class="pure-control-group">
                                <label for="summary">Summary</label>
                                <input name="summary" id="summary" value="{{summary}}" class="w24">
                            </div>
                        </form>

                        <form method="post" class="pure-form pure-form-aligned">
                            <div class="pure-control-group">
                                <label for="assigned-to">Assigned to:</label>
                                <select name="assigned-to" id="assigned-to">
                                    {{#selected assignedTo}}
                                    <option value="">&nbsp;</option>
                                    {{#users}}
                                    <option value="{{_id}}">{{firstname}} {{lastname}}</option>
                                    {{/users}}
                                    {{/selected}}
                                </select>
                            </div>
                        </form>

                        <form method="post" class="pure-form pure-form-aligned">
                            <div class="pure-control-group">
                                <label for="status" title="any status values can be used to suit your workflow">Status:</label>
                                <input name="status" id="status" value="{{status}}" list="statuses">
                                <datalist id="statuses">
                                    {{#statuses}}
                                    <option>{{this}}</option>
                                    {{/statuses}}
                                </datalist>
                            </div>
                        </form>

                        <form method="post" class="pure-form pure-form-aligned">
                            <div class="pure-control-group">
                                {{#checked archived}}
                                <label>Archive</label>
                                <input type="radio" name="archived" id="archived-n" value="n"> <label for="archived-n">Active</label>
                                <input type="radio" name="archived" id="archived-y" value="y"> <label for="archived-y">Archived</label>
                                {{/checked}}
                            </div>
                        </form>

                        <div id="tag-list">Tags: {{#tags}}
                            <span class="tag">{{this}} <button title="remove tag" class="tag-del hide fa fa-trash red"></button></span> {{/tags}}
                            <button id="tag-add" title="add tag" class="fa fa-plus green"></button></div>
                        <div id="new-tag" class="hide">
                            <span class="grey">#</span><input name="tag" id="tag" list="tags" placeholder="enter tag">
                            <button id="tag-save" title="add tag" class="fa fa-check green"></button>
                            <button id="tag-cancel" title="cancel" class="fa fa-times red"></button>
                        </div>
                        <datalist id="tags">
                            {{#tagList}}
                            <option value="{{this}}">
                                {{/tagList}}
                        </datalist> {{#if otherReports}}
                        <p>Other reports by {{by}}:</p>
                        <table>
                            {{#otherReports}}
                            <tr>
                                <td></td>
                                <td><a href="/reports/{{_id}}">{{reported}}</a></td>
                                <td>{{name}}</td>
                                <td>{{summary}}</td>
                            </tr>
                            {{/otherReports}}
                        </table>
                        {{/if}}

                        <p><i>The contents of the incident report will vary according to the organisation/project the report
                            is submitted for.</i></p>

                        <span class="card-header">Audit trail</span>
                        <table id="updates">
                            {{#updates}}
                            <tr id="{{_id}}">
                                <td><span class="nowrap">{{onDate}}</span> {{onTime}}</td>
                                <td>@{{by}}</td>
                                <td>{{description}}</td>
                            </tr>
                            {{/updates}}
                        </table>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</main>

</body>

</html>
