<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>{{title}}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.8.0/css/bootstrap-slider.min.css" integrity="sha256-SimsGsu3ragCO+uhwd4Um5PUzUuc3Eg+pxshtVHXYpM=" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="/css/reports-filter.css">
    <style>
        /* TODO: maybe won't want to keep delete function on this page, but useful for testing */

        button.fa-trash {
            background: none;
            border: none;
            color: #990000;
        }

        button.fa-trash:hover {
            cursor: pointer;
        }

        td.action, th.action {
            border: none;
            min-width: 2em;
        }

        td.assigned, span.tag {
            color: #406591;
            cursor: pointer;
        }

        td form {
            margin: 0;
        }
    </style>
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.8.0/bootstrap-slider.min.js" integrity="sha256-Gdq5BxoczjhbEJLjrYKQ4fvBGx/EQrTWjDM2UrdTot0=" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/qs/6.4.0/qs.min.js" integrity="sha256-Epo8Yj1phr7IExs51UisfSWpmD5bmSf/DMeCcIUoBbM=" crossorigin="anonymous"></script>
    <script src="//unpkg.com/dateformat@2.0.0/lib/dateformat.js"></script>
    <script src="/js/report.js"></script>
    <script src="/js/reports.js"></script>
    <script> const slider = { oldest: '{{oldest}}', latest: '{{latest}}' }; </script>
    <script src="/js/reports-filter.js"></script>
    <script> // list of reports
        'use strict';
        document.addEventListener('DOMContentLoaded', async function() { // reports list

            // show/hide delete button on hover over report tr
            document.querySelectorAll('tr[id]').forEach(tr => tr.onmouseenter = function showDeleteButton() {
                this.querySelector('button').classList.remove('hide');
            });
            document.querySelectorAll('tr[id]').forEach(tr => tr.onmouseleave = function hideDeleteButton() {
                this.querySelector('button').classList.add('hide');
            });

            // report deletion confirmation pop-up
            document.querySelectorAll('form.delete').forEach(form => form.onsubmit = function confirmDelete() {
                return confirm('Are you sure you want to delete this report?');
            });

            // sorting: set search field or reverse current sort order
            document.querySelectorAll('span[data-sort]').forEach(el => el.onclick = function() {
                const qs = Qs.parse(location.search.slice(1));
                const sort = this.dataset.sort;
                if (!qs.sort && sort=='updated') {
                    // default sort clicking on updated: set reverse updated sort
                    qs.sort = 'updated-';
                } else if (qs.sort && sort==qs.sort.slice(0, sort.length)) {
                    // click on current sort: reverse sort order
                    qs.sort = sort==qs.sort ? sort+'-' : sort;
                } else {
                    // click on new sort: default sort to data-sort setting
                    qs.sort = sort;
                    if (sort == 'updated') delete qs.sort;
                }
                // TODO: if already sorted, use window.location.replace() to avoid excessive history
                window.location.href = window.location.pathname + (Qs.stringify(qs) ? '?'+Qs.stringify(qs) : '');
            });
            const sortIndicator = document.querySelector('span[data-sort={{sort.column}}]');
            sortIndicator.style.color = '#666666';
            sortIndicator.classList.remove('fa-sort');
            sortIndicator.classList.add('{{sort.asc}}'=='+' ? 'fa-sort-asc' : 'fa-sort-desc');

            // keep updated-ago current every 10 secs
            function updateAgo() {
                document.querySelectorAll('td[data-ago]').forEach(td => {
                    if (td.dataset.ago) td.textContent = ago(td.dataset.ago);
                });
            }
            setInterval(updateAgo, 10e3);
        });
    </script>
</head>
<body>

<header>
    {{>navpartial}}
</header>

<main>

<div class="float-right">
  <span>Export: CSV </span>
  <a href="{{exportCsv}}" title="Save as CSV" class="fa fa-file-excel-o"></a>
  <span>/ PDF </span>
  <a href="{{exportPdf}}" title="Save as PDF" class="fa fa-file-pdf-o"></a>
</div>

<h1>Reports</h1>

{{>errpartial}}

{{>filterpartial}}

<nav class="tabs">
    <ul>
        <li class="active"><a href="/reports">List ({{count}})</a></li>
        <li><a href="/reports-map{{@koa.request.search}}">Map</a></li>
    </ul>
</nav>


<table class="pure-table w100pc custom-table margin-tweak">
    <tr>
        <th>updated <span data-sort="updated" class="float-right fa fa-sort"></span></th>
        <th>assigned to <span data-sort="assigned" class="float-right fa fa-sort"></span></th>
        <th>status <span data-sort="status" class="float-right fa fa-sort"></span></th>
        <th>summary <span data-sort="summary" class="float-right fa fa-sort"></span></th>
        <th>tags</th>
        <th>submitted <span data-sort="submitted" class="float-right fa fa-sort"></span></th>
        <th>location <span data-sort="location" class="float-right fa fa-sort"></span></th>
        <th>from <span data-sort="from" class="float-right fa fa-sort"></span></th>
        <th></th>
        <th class="action"></th>
        <th class="action"></th>
    </tr>
    {{#reports}}
    <tr id="{{_id}}">
        <td data-ago="{{updatedOn}}" title="{{updatedOnPretty}} by @{{updatedBy}}" class="align-right">{{updatedAgo}}</td>
        <td class="assigned">{{#if assignedTo}}@{{assignedTo}}{{/if}}</td>
        <td>{{status}}</td>
        <td>{{{summary}}}</td>
        <td>{{#tags}}{{{this}}} {{/tags}}</td>
        <td title="{{reportedOnFull}} by {{reportedBy}}" class="align-right nowrap">{{reportedOnPretty}}</td>
        <td>{{location}}</td>
        <td>{{name}}</td>
        <td class="small grey">{{#if comments.length}}<span class="fa-stack fa-1x"><span class="fa fa-comment-o fa-stack-2x"></span><a href="/reports/{{_id}}" class="fa-stack-1x fa-stack-text fa-inverse">{{comments.length}}</a></span>{{/if}}</td>
        <td class="action"><a href="/reports/{{_id}}" title="view report" class="fa fa-search"></a></td>
        <td class="action"><form action="/reports/{{_id}}/delete" method="post" class="delete"><button name="delete" value="{{_id}}" class="fa fa-trash hide"></button></form></td>
    </tr>
    {{/reports}}
</table>

<p class="grey"><b>Notes</b></p>
<p class="grey"><i>Updated</i> filter: the <i>updated</i> column shows 'ago' vaues: should the
    <i>updated</i> filter also be by 'ago' values, or by dates?</p>
<p class="grey">Formatting issues to be addressed on <i>submitted</i> range filter.</p>
<p class="grey">Interaction for <i>summary</i> was designed before I came up with the 'enter-in-place'
    mechanism for <i>report fields</i> â€“ perhaps the <i>report fields</i> approach would be better for
    <i>summary</i> also (though that would imply no drop-down arrow against summary, so I'm not
    entirely sure).</p>
<p class="grey">If number of <i>report fields</i> is likely to be very large, perhaps that should be
    implemented using some form of autocomplete.</p>
<p class="grey">Think about use of history.</p>
<p class="grey">Should there be a 'delete report' function?</p>

</main>

</body>
</html>
