<form method="post" enctype="multipart/form-data" class="pure-form pure-form-aligned">
    {{> flash}}
    <ul class="validation-errors">{{#@koa.flash.validation}}<li>{{this}}</li>{{/@koa.flash.validation}}</ul>

    <div>
        <h1>Have you used this anonymous reporting service before?</h1>

        <ul>
            {{#checked used-before}}
            <li>
                <input type="radio" name="used-before" id="used-before-y" value="y">
                <label for="used-before-y" class="pure-radio greyed-out-unless-checked">Yes</label>
                <div id="use-existing" class="hide">
                    <label for="existing-alias">Enter your anonymous alias</label>
                    <input type="text" name="existing-alias" id="existing-alias" value="{{existing-alias}}">
                    <span id="alias-ok" title="alias available" class="alias-available hide">✓</span>
                    <span id="alias-nok" title="alias not available" class="alias-available hide">✗</span>
                </div>
            </li>
            <li>
                <input type="radio" name="used-before" id="used-before-n" value="n" checked>
                <label for="used-before-n" class="pure-radio greyed-out-unless-checked">No</label>
                <div id="use-generated">
                    <p>We make sure that your report is anonymous by creating a random identification alias.</p>
                    <p>If you want to follow up, use the anonymous alias below so we can access any relevant information.</p>
                    <p>This report will use <b><output name="generated-alias">{{generated-alias}}</output></b>
                        <input type="hidden" name="generated-alias" value="{{generated-alias}}"></p>
                    <button type="button" id="get-alt-alias" class="inline-link">Generate another random alias</button>
                </div>
            </li>
            {{/checked}}
        </ul>
    </div>

    <hr>

    <div>

        <h1>Are you reporting on behalf of yourself or someone else?</h1>

        <ul id="on-behalf-of">
            {{#checked on-behalf-of}}
            <li>
                <input type="radio" name="on-behalf-of" id="on-behalf-of-myself" value="myself">
                <label for="on-behalf-of-myself">Myself</label>
            </li>
            <li>
                <input type="radio" name="on-behalf-of" id="on-behalf-of-someone-else" value="someone-else">
                <label for="on-behalf-of-someone-else">Someone else</label>
            </li>
            {{/checked}}
        </ul>
    </div>

    <hr>

    <div>
        <h1>{{q.3a}}</h1>

        <p class="hint-text">We understand this can be difficult. Please take your time and tell us
            as much as you are able.</p>

        <ul id="when">
            {{#checked when}}
            <li>
                <input type="radio" name="when" id="when-date" value="date">
                <label for="when-date" class="pure-radio">Yes, exactly when it happened</label>
                <div class="when-form" style="display:none;">
                    <p class="hint-text">Please select the date and approximate time</p>
                    <table class="inline">
                        <tr class="field-label">
                            <td>DD</td>
                            <td>MMM</td>
                            <td>YYYY</td>
                        </tr>
                        <tr>
                            <td>
                                <select name="date.day" id="date.day" class="w4">
                                    {{#selected date.day}}
                                    {{#incidentDate.days}}
                                    <option value="{{this}}">{{this}}</option>
                                    {{/incidentDate.days}}
                                    {{/selected}}
                                </select>
                            </td>
                            <td>
                                <select name="date.month" id="date.month" class="w5">
                                    {{#selected date.month}}
                                    {{#incidentDate.months}}
                                    <option value="{{this}}">{{this}}</option>
                                    {{/incidentDate.months}}
                                    {{/selected}}
                                </select>
                            </td>
                            <td>
                                <select name="date.year" id="date.year" class="w6">
                                    {{#selected date.year}}
                                    {{#incidentDate.years}}
                                    <option value="{{this}}">{{this}}</option>
                                    {{/incidentDate.years}}
                                    {{/selected}}
                                </select>
                            </td>
                        </tr>
                    </table>

                    <div class="inline">
                        <br>at
                        <select name="date.time" id="date.time">
                            <option></option>
                            {{#selected date.time}}
                            {{#incidentDate.hours}}
                            <option value="{{this}}">{{this}}</option>
                            {{/incidentDate.hours}}
                            {{/selected}}
                        </select>
                    </div>
                </div>
            </li>
            <li>
                <input type="radio" name="when" id="when-within" value="within">
                <label for="when-within">Yes, about when it happened</label>
                <p class="hint-text">For example, last month, a couple of years ago, …</p>
                <select name="within-options" id="within-options">
                    {{#selected within-options}}
                    <option></option>
                    <option value="within last week">last week</option>
                    <option value="within last month">last month</option>
                    <option value="within last year">last year</option>
                    <option value="more than a year ago">more than a year ago</option>
                    {{/selected}}
                </select>
            </li>
            <li>
                <input type="radio" name="when" id="when-dont-remember" value="dont-remember">
                <label for="when-dont-remember">I do not remember</label>
            </li>
            <li>
                <input type="radio" name="when" id="when-skip" value="skip">
                <label for="when-skip">Skip</label>
            </li>
            {{/checked}}
        </ul>

        <h1>Is it still happening?</h1>

        <ul id="still-happening">
            {{#checked still-happening}}
            <li>
                <input type="radio" name="still-happening" id="still-happening-y" value="y">
                <label for="still-happening-y">Yes</label>
            </li>
            <li>
                <input type="radio" name="still-happening" id="still-happening-n" value="n" class="radio-margin"> <!-- TODO: class? -->
                <label for="still-happening-n">No</label>
            </li>
            <li>
                <input type="radio" name="still-happening" id="still-happening-skip" value="skip" class="radio-margin"> <!-- TODO: class? -->
                <label for="still-happening-skip">Skip</label>
            </li>
            {{/checked}}
        </ul>
    </div>

    <hr>

    <div>

        <h1>{{q.4a}}</h1>

        <p class="hint-text"></p>
        <ul id="where">
            {{#checked where}}
            <li>
                <input type="radio" name="where" id="where-at" value="at"> <label for="where-at">Location</label>
                <p class="hint-text">Please provide as much detail as you are able – this could be
                    an address, restaurant name, or neighborhood or sights and landmarks you recall.</p>
                <textarea rows="4" name="at-address" id="at-address" class="w100pc">{{at-address}}</textarea>
            </li>
            <li>
                <input type="radio" name="where" id="where-dont-know" value="dont-know">
                <label for="where-dont-know">I don’t know</label>
            </li>
            <li>
                <input type="radio" name="where" id="where-skip" value="skip">
                <label for="where-skip">Skip</label>
            </li>
            {{/checked}}
        </ul>
    </div>

    <hr>

    <div>
        <h1>Do you know who did it?</h1>

        <p class="hint-text">This could be one person or multiple people.</p>
        <ul id="who">
            {{#checked who}}
            <li>
                <input type="radio" name="who" id="who-y" value="y">
                <label for="who-y" class="pure-radio greyed-out-unless-checked">Yes</label>
                <div id="who-y-form" class="hide">
                    <label for="who-relationship">
                        <p class="hint-text">Please give us a description of the person/people. Please
                            include how you know them (for example, it could be a relative, colleague,
                            or acquaintance.</p>
                    </label>
                    <textarea name="who-relationship" id="who-relationship" rows="4" class="w100pc">{{who-relationship}}</textarea>
                </div>
            </li>
            <li>
                <input type="radio" name="who" id="who-n" value="n">
                <label for="who-n" class="pure-radio greyed-out-unless-checked">No</label>
                <div id="who-n-form" class="hide">
                    <p class="hint-text">Please give us as much description as you are able.</p>
                    <textarea name="who-description" id="who-description" rows="4" class="pure-input-1">{{who-description}}</textarea>
                </div>
            </li>
            <li>
                <input type="radio" name="who" id="who-skip" value="skip">
                <label for="who-skip" class="pure-radio greyed-out-unless-checked">Skip</label>
            </li>
            {{/checked}}
        </ul>
    </div>

    <hr>

    <div>
        <script>
            'use strict';
            document.addEventListener('DOMContentLoaded', function () {
                document.querySelector('input[type=file]').onchange = cloneFileInput; // change handler for initial file input
                function cloneFileInput(event) {
                    const fileInputs = document.querySelectorAll('input[type=file]');
                    const el = event.target;
                    // if we already have a 'no file chosen' input, don't clone another
                    for (const i of fileInputs) if (i.files.length == 0) return;
                    // if same file has already been chosen, clear the filename & don't clone
                    const inputsWithThisName = [...fileInputs].filter(f => f.files[0].name == el.files[0].name)
                    if (inputsWithThisName.length > 1) { el.value = ''; return; }
                    const copy = el.cloneNode(true);
                    copy.onchange = cloneFileInput;
                    copy.value = '';
                    copy.id = 'document' + (fileInputs.length);
                    el.insertAdjacentElement('afterend', copy)
                }
            });
        </script>

        <h1>This is an anonymous service. Any information you provide will be seen only by staff and
            volunteers of Global Rights Nigeria.</h1>

        <p class="hint-text">{{q.6a}}</p>

        <ul>
            {{#checked description}}
            <li>
                <label for="description">Description:</label>
                <textarea name="description" id="description" rows="4" class="pure-input-1">{{description}}</textarea>
            </li>
            <li>
                <label for="document0">
                    <strong>Please upload any evidence that could help.</strong>
                    This can be photos, videos or any other documents.
                    {{#if files}}
                    <span class="note">note: please reselect
                        {{#each files}}{{this.name}}{{#unless @last}}, {{/unless}}{{/each}}
                        if you wish to submit them</span>
                    {{/if}}
                </label>
                <input type="file" name="documents" value="0" id="document0" class="upload-file">
            </li>
            <li>
                <input type="radio" name="description" id="description-skip" value="skip">
                <label for="description-skip" class="pure-radio greyed-out-unless-checked">Skip</label>
            </li>
            {{/checked}}
        </ul>

        <h1>{{q.6b}}</h1>
        <h3>Gender</h3>
        <ul>
            {{#checked survivor-gender}}
            <li>
                <input type="radio" name="survivor-gender" id="survivor-gender-m" value="m"> <label for="survivor-gender-m">Male</label>
            </li>
            <li>
                <input type="radio" name="survivor-gender" id="survivor-gender-f" value="f"> <label for="survivor-gender-f">Female</label>
            </li>
            <li>
                <input type="radio" name="survivor-gender" id="survivor-gender-skip" value="skip"> <label for="survivor-gender-skip">Skip</label>
            </li>
            {{/checked}}
        </ul>

        <h3>Age</h3>
        <ul>
            <li>
                <label for="survivor-age"></label>
                <select name="survivor-age" id="survivor-age" class="w16">
                    {{#selected survivor-age}}
                    <option></option>
                    <option>0–4</option>
                    <option>5–9</option>
                    <option>10–14</option>
                    <option>15–19</option>
                    <option>20–24</option>
                    <option>25–29</option>
                    <option>30–34</option>
                    <option>35–39</option>
                    <option>40–44</option>
                    <option>45–49</option>
                    <option>50–54</option>
                    <option>55–59</option>
                    <option>60–64</option>
                    <option>65–69</option>
                    <option>70–74</option>
                    <option>75–79</option>
                    <option>80+</option>
                    {{/selected}}
                </select>
            </li>
            <li>
                <input type="radio" name="survivor-age" id="survivor-age-skip" value="skip"> <!-- radio with just one option? -->
                <label for="survivor-age-skip" class="pure-radio greyed-out-unless-checked">Skip</label>
            </li>
        </ul>
    </div>

    <hr>

    <div>
        <h1>{{q.7a}}</h1>

        <p class="hint-text">Pick all options that apply. For each, please provide any additional
            information you are able in the text fields (for example, whether any actions taken as a
            result of your conversation).</p>

        <ul id="action-taken">
            {{#checked action-taken}}
            <li>
                <input type="checkbox" name="action-taken" id="action-taken-police" value="police">
                <label for="action-taken-police">Police or government officials</label>
                <input type="text" name="action-taken-police-details" id="action-taken-police-details" value="{{action-taken-police-details}}" class="details hide w16">
            </li>
            <li>
                <input type="checkbox" name="action-taken" id="action-taken-organisation" value="organisation">
                <label for="action-taken-organisation">Somebody within an organisation</label>
                <input type="text" name="action-taken-organisation-details" id="action-taken-organisation-details" value="{{action-taken-organisation-details}}" class="details hide w16">
            </li>
            <li>
                <input type="checkbox" name="action-taken" id="action-taken-teacher" value="teacher">
                <label for="action-taken-teacher">Teacher/tutor/lecturer</label>
                <input type="text" name="action-taken-teacher-details" id="action-taken-teacher-details" value="{{action-taken-teacher-details}}" class="details hide w16">
            </li>
            <li>
                <input type="checkbox" name="action-taken" id="action-taken-friends" value="friends">
                <label for="action-taken-friends">Friends, family</label>
                <input type="text" name="action-taken-friends-details" id="action-taken-friends-details" value="{{action-taken-friends-details}}" class="details hide w16">
            </li>
            <li>
                <input type="checkbox" name="action-taken" id="action-taken-others" value="others">
                <label for="action-taken-others">Others</label>
                <input type="text" name="action-taken-others-details" id="action-taken-others-details" value="{{action-taken-others-details}}" class="details hide w16">
            </li>
            <li>
                <input type="radio" name="action-taken" id="action-taken-skip" value="skip"> <!-- checkbox/radio with same name? -->
                <label for="action-taken-skip" class="pure-radio greyed-out-unless-checked">Skip</label>
            </li>
            {{/checked}}
        </ul>
    </div>

    <hr>

    <div>
        <h1>Is there anything else you would like to add?.</h1>

        <ul>
            <li>
                <label for="extra-notes">Extra notes:</label>
                <textarea class="pure-input-1" name="extra-notes" id="extra-notes" rows="4">{{extra-notes}}</textarea>
            </li>
        </ul>
    </div>

    <div class="text-center">
        <button type="submit" name="nav-next" value="next" accesskey="c" class="nav-action-button pure-button-primary pure-button">Submit and continue to Resources</button>
    </div>
    {{> notworking}}

</form>
