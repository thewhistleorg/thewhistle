<!doctype html>
<html lang="en">
<head>
    <title>The Whistle / Global Rights Nigeria Incident Report</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="//unpkg.com/purecss@1.0.0/build/pure-min.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/grn.css">
    <style>
        main h1 { clear: both;  margin-top: 1em; }
        input { margin-right: 0.2em; width: 16em; }
        output { font-weight: bold; }
        button#get-alt-name { margin-left: 1em;  margin-top: 1em; }
        .name-available { float: right; font-weight: bold; margin-top: 1em; }
        #name-ok { color: #009900; }
        #name-nok { color: #990000; }
    </style>
    <script defer src="/js/report.js"></script>
    <script>
        'use strict';

        // use ajax to fill in name so that no special treatment is required within handlers

        document.addEventListener('DOMContentLoaded', async function() {

            // if we have no name on opening page, fetch a random one
            if (document.querySelector('#generated-name').value == '') generateName();

            if (document.querySelector('#existing-name').value.trim() != '') {
                await verifyExistingName(document.querySelector('#existing-name').value);
            }

            // listener for 'get alternative' name button
            document.querySelector('#get-alt-name').onclick = generateName;

            // check entered existing name letter-by-letter
            document.querySelector('#existing-name').oninput = async function() {
                await verifyExistingName(this.value);
            };

        });

        async function generateName() {
            const headers = { Accept: 'application/json' };
            const credentials = 'same-origin';
            const response = await fetch('/ajax/test/names/new', { method: 'GET', headers, credentials });
            const body = await response.json();
            if (response.ok) {
                document.querySelector('#generated-name').value = body.name;
                document.querySelector('input[name=generated-name]').value = body.name;
                //await verifyExistingName(body.name);
            } else {
                alert(body.message);
            }
        }

        async function verifyExistingName(name) {
            if (name.trim() == '') {
                document.querySelector('#existing-name').setCustomValidity('');
                document.querySelector('#name-ok').classList.add('hide');
                document.querySelector('#name-nok').classList.add('hide');
                document.querySelector('#generated-name').classList.remove('hide');
                return;
            }
            const headers = { Accept: 'application/json' };
            const credentials = 'same-origin';
            const response = await fetch('/ajax/test/names/'+name, { method: 'GET', headers, credentials });
            const body = await response.json();
            switch (response.status) {
                case 200: // name exists
                    document.querySelector('#existing-name').setCustomValidity('');
                    document.querySelector('#name-ok').classList.remove('hide');
                    document.querySelector('#name-nok').classList.add('hide');
                    document.querySelector('#generated-name').classList.add('hide');
                    break;
                case 404: // name not found
                    const err = 'Name not found';
                    document.querySelector('#existing-name').setCustomValidity(err);
                    document.querySelector('#name-ok').classList.add('hide');
                    document.querySelector('#name-nok').classList.remove('hide');
                    document.querySelector('#generated-name').classList.remove('hide');
                    break;
                default: // ?? eg 500?
                    alert(response.body);
                    break;
            }
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            'use strict';

            document.querySelector('input[type=file]').onchange = cloneFileInput; // change handler for initial file input

            function cloneFileInput(event) {
                const fileInputs = document.querySelectorAll('input[type=file]');
                const el = event.target;
                // if we already have a 'no file chosen' input, don't clone another
                for (var i of fileInputs) if (i.files.length==0) return;
                // if same file has already been chosen, clear the filename & don't clone
                const inputsWithThisName = [...fileInputs].filter(f => f.files[0].name==el.files[0].name)
                if (inputsWithThisName.length > 1) { el.value = ''; return; }
                const copy = el.cloneNode(true);
                copy.onchange = cloneFileInput;
                copy.value = '';
                copy.id = 'document'+(fileInputs.length);
                el.insertAdjacentElement('afterend', copy)
            }
        });
    </script>
</head>
<body>

<header>
    <nav class="pure-menu pure-menu-horizontal">
        <ul class="pure-menu-list">
            <li class="pure-menu-item"><img src="../img/logo-32.png"></li>
            <li class="pure-menu-item">The Whistle | Global Rights Nigeria Incident Report</li>
        </ul>
    </nav>
</header>

<main>

<form method="post" enctype="multipart/form-data" class="pure-form pure-form-aligned">

<ul class="validation-errors">{{#@koa.flash.validation}}<li>{{this}}</li>{{/@koa.flash.validation}}</ul>

<h1>Identifier name</h1>

<p>Your reports are kept anonymous, so to keep a record of you internally, we will use an
    auto-generated name. If you would prefer an alternative name, click on the ‘get alternative name’
    button.</p>

<p>Please make a note of this name, so that we can associate you with this report in any future
    contacts we may have with you.</p>

<p>If you are making another report, please enter your existing auto-generated name in the ‘existing name’
    field.</p>

    <ul>
        <li>
            <label>Auto-generated identifier name:</label>
            <button type="button" id="get-alt-name" autofocus class="float-right">get alternative name</button>
            <output id="generated-name">{{generated-name}}</output>
            <input type="hidden" name="generated-name" value="{{generated-name}}">
        </li>
        <li>
            <label for="existing-name">...or existing identifier name</label>
            <span id="name-ok" title="name available" class="name-available hide">✓</span>
            <span id="name-nok" title="name not available" class="name-available hide">✗</span>
            <input type="text" name="existing-name" id="existing-name" value="{{existing-name}}">
        </li>
    </ul>

<h1>Survivor</h1>

    <ul>
        <li>
            <label for="survivor-age">Age</label>
            <input type="number" name="survivor-age" id="survivor-age" value="{{survivor-age}}" autofocus>
        </li>
        <ul>
            {{#checked survivor-gender}}
            <li>
                <label>Gender of alleged survivor(s)</label>
                <input type="radio" name="survivor-gender" id="survivor-gender-m" value="m"> <label for="survivor-gender-m">Male</label>
                <input type="radio" name="survivor-gender" id="survivor-gender-f" value="f"> <label for="survivor-gender-f">Female</label>

            </li>
            {{/checked}}
        </ul>
    </ul>

<h1>Date / time</h1>
<p>What was the date/time the incident occurred?</p>

    <ul>
        <li>
            <label for="date">What date did the incident occur?</label>
            <input type="date" name="date" id="date" value="{{date}}" required autofocus>
        </li>
        <li>
            <label for="time">What time was it when the incident took place</label>
            <input type="time" name="time" id="time" value="{{time}}" required>
        </li>
    </ul>

<h1>Description</h1>
<p>Give a brief description of the incident</p>

    <ul>
        <li>
            <label for="brief-description">Description</label>
            <textarea name="brief-description" id="brief-description" cols="48" rows="8" required autofocus>{{brief-description}}</textarea>
        </li>
    </ul>

<h1>Location</h1>

    <ul>
        <li>
            <label for="location-address">Location address (used for geocoding)</label>
            <input type="text" name="location-address" id="location-address" value="{{location-address}}" required autofocus>
        </li>
        <li>
            <label for="location-description">Full description of location</label>
            <textarea name="location-description" id="location-description">{{location-description}}</textarea>
        </li>
    </ul>

<h1>Perpetrator</h1>

    <ul>
        <li>
            <label for="perpetrator-identity">Identity of perpetrator</label>
            <input type="text" name="perpetrator-identity" id="perpetrator-identity" value="{{perpetrator-identity}}" autofocus>
        </li>
        <li>
            <label for="perpetrator-relationship">Relationship with perpetrator</label>
            <input type="text" name="perpetrator-relationship" id="perpetrator-relationship" value="{{perpetrator-relationship}}">
        </li>
        <li>
            <label for="perpetrator-age">Age</label>
            <input type="text" name="perpetrator-age" id="perpetrator-age" value="{{perpetrator-age}}">
        </li>
        <ul>
            {{#checked perpetrator-gender}}
            <li>
                <label>Gender of alleged perpetrator(s)</label>
                <input type="radio" name="perpetrator-gender" id="perpetrator-gender-m" value="m"> <label for="perpetrator-gender-m">Male</label>
                <input type="radio" name="perpetrator-gender" id="perpetrator-gender-f" value="f"> <label for="perpetrator-gender-f">Female</label>
            </li>
            {{/checked}}
        </ul>
    </ul>

<h1>Action taken</h1>

    <ul>
        <li>
            <label for="action-taken">Action taken so far</label>
            <input type="text" name="action-taken" id="action-taken" value="{{action-taken}}" autofocus>
        </li>
    </ul>

<h1>Photographs</h1>

    <ul>
        <li>
            <label for="document0">Upload photos / videos / documents documenting the incident
                {{#if files}}<span class="note">note: please reselect {{#each files}}{{this.name}}{{#unless @last}}, {{/unless}}{{/each}} if you wish to submit them</span>{{/if}}</label>
            <input type="file" name="documents" value="0" id="document0">
        </li>
        <li class="nav">
            <button type="submit" name="nav-next" value="next" accesskey="n" class="nav next"><u>N</u>ext ⇒</button>
        </li>
    </ul>

</form>

</main>

</body>
</html>
